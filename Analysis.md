# 一. 分析影响颅内感染的主要因素有哪些？

## 数据集观察

数据集主要可以作以下划分

| 说明：       | 病人唯一标识 | 性别/年龄   | 主要诊断+其他诊断\*n       | (手术方式/麻醉方式)n + 手术持续时间      | 样本编号(采样次数唯一标识) | 量化项目            |
| :----------- | :----------- | :---------- | :------------------------- | :--------------------------------------- | -------------------------- | ------------------- |
| 原数据标识： | mr_bah       | mr_xb/mr_nn | mr_cyzyzdmc+mr_cyqtzdmc{n} | mr_ssmzfs{n}/mr_sscxsj{n} + mr_ssmzfs{k} | item_code                  | result quantitative |

其中“颅内感染”主要包含在诊断中。数据的对应关系是 1 个病人对应 n 个样本编号（n 不固定）。

对于以上的数据集划分，我们很自然地想到了颅内感染的可能影响因素：

1. 其他病症对“颅内感染”的发生有影响
2. 手术方式对“颅内感染”的发生有影响
3. 手术时间对“颅内感染”的发生有影响

## 数据集预处理

取出数据集中的 [病人唯一标识,性别/年龄,主要诊断+其他诊断\*n,(手术方式/麻醉方式)n + 手术持续时间] 并去除重复列，这样我们就能得到由病人唯一标识作为索引的数据集。

## 分析手术对颅内感染的影响
### 分析手术方式对颅内感染的影响
因为数据集“主要诊断”一列并未包含“颅内感染”，因此我们分析手术是为了治疗主要诊断，而颅内感染发生在手术之后。因此颅内感染与手术之间就具有时间的先后顺序，即颅内感染是手术过程中发生的或手术后发生了颅内感染。因此我们一旦确定了手术与颅内感染的相关性，便可以尽可能地说明，手术对颅内感染产生了影响（这与后来分析其他病症对颅内感染的影响不同）

#### 引入独热编码（One-Hot Encoding）
独热编码是针对具有明确分类值的数据进行预处理的有效方法，通过将每个分类值转换为独立的二进制向量，确保模型正确理解非数值分类特征，避免数值关系的误判。

独热编码举例：

    给定一个标签列表[A,D,C,B],我们需要将其转化成0-1编码，即：
    ["A","B","C","D"]
    [1,0,0,0]
    [0,0,0,1]
    [0,0,1,0]
    [0,1,0,0]


由于每个病人所包含的手术方式数量不统一，且为了方便后续的操作，我们先把数据中的手术方式转化成 one_hot_encoding。为接下来实现计算颅内感染与手术方式的相关性分析，我们将手术方式的独热编码矩阵中加入“是否有颅内感染”这一项。我们选择去除掉样本数量过少的标签。这样我们就获得了手术方式的one hot矩阵 $\Psi$。

one hot矩阵 $\Psi$的列和行表示都是各种手术方式（最后一列和行表示“是否发生颅内感染”）。某一元素$\Psi_{i,j}$表示对应第$i$行类别与对应第$j$列类别是否同时发生。此外，最后一列（或行）表示颅内感染和手术方式是否一起产生。

#### 计算皮尔逊相关性系数矩阵
皮尔逊系数通常是为了衡量两个变量之间的线性相关性。皮尔逊系数的值介于 -1 和 1 之间，分别表示完全负相关和完全正相关，而 0 表示没有线性相关性。

虽然皮尔逊系数通常用于连续变量，但在特定情况下，它也可以用于离散变量。对于纯类别变量，如果这些类别能够以某种方式量化或编码成数值，皮尔逊相关系数也可以使用。当手术方式通过独热编码的方式转化为one hot矩阵时，$\Psi_{i,j}$的值表示是否同时发生（0代表未发生，1代表发生），实现了将类别编码化。

对于one-hot 矩阵 $\Psi$，我们现在计算其行列之间的皮尔逊相关系数矩阵。假设 $\Psi$ 是一个 $m \times n$ 的矩阵。我们可以计算矩阵 $\Psi$ 的皮尔逊相关系数矩阵 $\mathbf{R}$，其中 $\mathbf{R}_{k,l}$ 表示第 $k$ 列和第 $l$ 列之间的皮尔逊相关系数，公式如下：


$$
\mathbf{R}_{k,l} = \frac{\sum_{i=1}^m (\Psi_{i,k} - \bar{\Psi}_k)(\Psi_{i,l} - \bar{\Psi}_l)}{\sqrt{\sum_{i=1}^m (\Psi_{i,k} - \bar{\Psi}_k)^2} \sqrt{\sum_{i=1}^m (\Psi_{i,l} - \bar{\Psi}_l)^2}} 
$$

其中：
- $\bar{\Psi}_k$ 表示第 $k$ 列的均值，计算公式为 $\bar{\Psi}_k = \frac{1}{m} \sum_{i=1}^m \Psi_{i,k}$。
- $\bar{\Psi}_l$ 表示第 $l$ 列的均值，计算公式为 $\bar{\Psi}_l = \frac{1}{m} \sum_{i=1}^m \Psi_{i,l}$。

观察得到的皮尔逊系数矩阵$\mathbf{R}$ （该矩阵已保留至:zzzz，读者也可以自行观察），我们可以发现最后一列（或行）表示颅内感染与手术方式间的相关性系数。其中，我们发现，负值较少且大多接近于0，而正值中，在数值0.4出有明显分割（0.4以上的值大多分布在0.45-0.65,0.4以下的值大多分布在0.3以下）。因此我们选择0.4为分割阈值，选出相关性系数大于阈值的手术方式。

最后我们得到相关性较高的手术方式为：内镜下面神经微血管减压术，脑室分流管去除术，后颅窝病损切除术，脑室Ommaya泵置入术，侧脑室脑池造口引流术。
#### 计算条件概率
皮尔逊系数可以帮助我们了解变量之间的线性相关性程度。然而，线性相关性并不总能完整地揭示变量之间的全部关系。通过计算条件概率，特别是在给定其他变量条件下的概率，可以更深入地理解变量之间是否存在更为复杂的依赖关系。例如，假设我们通过皮尔逊系数分析发现两个变量之间存在高度正相关。为了进一步理解它们的关系，我们可以计算在一个变量取特定值时另一个变量发生的条件概率。如果这种条件概率明显高于随机情况下的概率，这可能暗示着它们之间存在更为深层次的依赖关系。因此，可以更进一步地探究影响颅内感染的手术方式。

已知条件概率计算方式如下：
$A="颅内感染"$,$B="任一手术方式"$
$$P(A|B) = P(AB)/P(B)$$


我们要计算在第k列和第l列同时为1的次数，即类别 A 和类别 B 同时出现的次数。这可以通过逐行检查独热矩阵 $\Psi$ 来实现,公式如下：

$\text{count}(A \text{ and } B) = \sum_{i=1}^m \Psi_{i,k} \cdot \Psi_{i,l} $

要计算类别 B 出现的总次数，即第 l 列的所有行中值为1的次数。统计方式可以描述如下：

$\text{count}(B) = \sum_{i=1}^m \Psi_{i,k}$

最后我们得到发生颅内感染的条件概率，将条件概率筛选出来的手术方式与相关性系数筛选出来的手术方式进行交集，可以得到，与发生颅内感染高度相关的手术方式为：'侧脑室脑池造口引流术' '后颅窝病损切除术' '脑室Ommaya泵置入术' '脑室分流管去除术'。

## 分析其他病症对“颅内感染”的影响

(内容详见./illness_analysis.ipynb)

与手术不同，其他病症与颅内感染的关系并不具有可判定的时间关系。即仅考虑手术的情况下，颅内感染必然发生在手术时或者手术后，共两种情况，并且这两种情况都可以说明手术影响了颅内感染（具有因果性）。

但是，其他病症与颅内感染的关系有如下三种情况：
- 颅内感染与其他疾病并发
- 颅内感染导致了其他疾病
- 其他疾病导致了颅内感染

要分析“影响颅内感染的主要因素有哪些”这一问题，“颅内感染导致了其他病症”这一条显然不能包括在内。因此，单单仅分析相关性是不够的。所以，在分析其他病症对颅内感染的影响时，除了与之前一样计算相关性和条件概率，我们通过贝叶斯网络，试图分析出因果关系。
### 相关性：利用皮尔逊系数和条件概率
与之前xxxx节相似，我们做出病症的one hot矩阵 $\Chi$ ，该矩阵中的元素 $\Chi_{i,j}$ 说明第i行代表的症状是否与第j行代表的症状同时观察到。然后根据矩阵 $\Chi$ 做出皮尔逊系数矩阵。
再运用xxxx节求条件概率的方法，我们得出其他病发生情况下，颅内感染和该病一同发生的条件概率。
通过同样的方法设置阈值，最后可以筛选出'低钠血症' '外展神经损伤' '多发性大脑挫裂伤' '小脑恶性肿瘤' '手术后切口愈合不良' '脑实质出血继发蛛网膜下腔出血'
 '脑室腹腔分流管置入感染'这些病症与颅内感染有关。
### 因果性：利用贝叶斯网络
贝叶斯网络(Bayesian network)，又称信念网络(Belief Network)，或有向无环图模型(directed acyclic graphical model)，是一种概率图模型。它是一种模拟人类推理过程中因果关系的不确定性处理模型，其网络拓朴结构是一个有向无环图(DAG)。

病症矩阵one hot $\Chi$ 中包含颅内感染，现在要判断其他病症与颅内感染的因果性。贝叶斯网络通过图结构 $ G = (V, E)$ 来描述变量之间的条件依赖关系。假设变量 $ I $ 表示颅内感染，而其他变量集合为 ${S_1, S_2, \ldots, S_n}$，表示其他病症。
- **节点集合** $ V = \{I, S_1, S_2, \ldots, S_n\} $
- **边集合** $ E $ 表示变量之间的依赖关系。

（1） **首先进行一般情况推导**

贝叶斯网络中，每个节点 $ X_i$ 的条件概率分布 $ P(X_i \mid \text{Pa}(X_i)) $ 可以通过以下方式计算：

$ P(X_i \mid \text{Pa}(X_i)) = \frac{P(X_i, \text{Pa}(X_i))}{P(\text{Pa}(X_i))} $

其中：
- $ \text{Pa}(X_i) $ 表示节点 $ X_i $ 的父节点集合。
- $ P(X_i, \text{Pa}(X_i)) $ 是节点 $ X_i $ 和其父节点的联合概率。
- $ P(\text{Pa}(X_i)) $ 是父节点的边缘概率分布。

选择贝叶斯估计（Bayesian Estimation），它的好处在于好处在于能够有效处理不确定性，通过结合先验知识和观测数据，提供准确且灵活的估计结果。此外，贝叶斯估计还能够适应复杂问题的建模与解决。
实验中，对于贝叶斯估计，我们选择 Dirichlet 分布作为分类变量的条件概率分布的先验。Dirichlet 分布的参数通常用$\alpha$表示，它决定了先验分布的平滑程度.
对于每个节点$X_i$其条件概率分布 $P(X_i\mid \text{Pa}(X_i))$的先验分布可以表示为：

$ P(X_i \mid \text{Pa}(X_i)) \sim \text{Dirichlet}(\alpha_{X_i, \text{Pa}(X_i)}) $
其中，$\alpha_{X_i, \text{Pa}(X_i)}$是 Dirichlet 分布的参数，可以根据应用的具体情况选择。可根据经验设置或者进行参数调优。

现在对贝叶网络进行求解得到：

$ P(X_i = x_i \mid \text{Pa}(X_i)) \propto \frac{\text{Count}(X_i = x_i, \text{Pa}(X_i)) + \alpha}{\sum_{x_i'} (\text{Count}(X_i = x_i', \text{Pa}(X_i)) + \alpha)} $
其中，$ \text{Count}(X_i = x_i, \text{Pa}(X_i)) $ 是在给定父节点条件下节点 $ X_i $ 取值为 $ x_i $ 的计数。

（2）**将构造的图结构$ G = (V, E)$带入求解公式**

假设 $ S_1, S_2, \ldots, S_n $ （节点和节点个数可以任选）是颅内感染 $ I $的潜在父节点，我们可以计算颅内感染的条件概率为：

$ P(I \mid S_1, S_2, \ldots, S_n) = \frac{P(I, S_1, S_2, \ldots, S_n)}{P(S_1, S_2, \ldots, S_n)} $

根据数据求解后验概率（估计值）：

$ P(I \mid S_1, S_2, \ldots, S_n) \propto \frac{\text{Count}(I, S_1, S_2, \ldots, S_n) + \alpha}{\sum_{I'} (\text{Count}(I', S_1, S_2, \ldots, S_n) + \alpha)} $
这里，$ \text{Count}(I, S_1, S_2, \ldots, S_n) $ 是在数据集中同时出现 $ I $ 和 $ S_1, S_2, \ldots, S_n $ 的次数。

**计算得到的后验概率可以用于推断其他病症$ S_1, S_2, \ldots, S_n $（节点和节点个数可以任选）对颅内感染$ I $的影响程度。较高的后验概率表明该病症可能导致颅内感染的可能性更大。**
我们的实验结果发现，在后验概率的值为0.3处，可以明显区分不同病症。得到概率较高的病症为：'外展神经损伤'，'脑室腹腔分流管置入感染'，'脑实质出血继发蛛网膜下腔出血''额叶交界性肿瘤'，'面肌痉挛'，'手术后切口愈合不良'，'手术后脑脊液漏'



## 量化结果分析

(详见./time_series_analysis.ipynb)

但是上面得出的结论是否是真正的结论呢，我们查看一些高概率的结果的频数发现只有 3-5 次，这意味着我们的结论不具备普遍统计意义，为了说明我们的结论正确性，我们对量化结果进行分析。

#### 为什么要分析量化结果？

量化结果是病症的原因，即得了某些病或者做了某些手术后我能看到人体的某些指标发生了变化，若“颅内感染”患者与“非颅内感染”患者在某些量化指标上存在明显差异，则我们可以尝试查询一些我们上面分析得出的结论对于的量化结果是否与“非颅内感染”患者存在明显差异，若存在明显差异则说明我们的结论是成立的。

#### 量化数据预处理

我们取出数据中的 [病人唯一标识， 样本编号(采样次数唯一标识) , 量化项目 ] 并将不同的量化项目直接嵌入到同一行中，这样我们就能够获得以样本编号为唯一标识的时间序列数据集。(详见./outputs/time_factor.csv)

#### 量化数据分析

因为第一次的量化分析距离病人的诊断最近，因此最有可能与病症产生关联，因此我们分析每一个病人的第一次量化数据，最后发现"颅内感染”患者与“非颅内感染”患者在三项蛋白指标上有明显差异，我们将这个作为判断依据。



# 二. 构建颅内感染的风险模型

(详见 model_build.ipynb)

## 时间序列处理

因为量化数据的采样时间越靠前，其指标就越与病症相关，并且我们的预测模型也只能预测定长数据，因此我们决定将时间序列压缩到一个值。

为了让采用时间越前的数据提供的重要性越高，我们对时间序列采用了指数平均:

$$\frac{\exp(-\alpha x)}{\left(\frac{1}{\alpha}\right) \exp(-\alpha n)}$$

## 输入数据

直接将上述所有预处理步骤得到的 one_hot ecoding 以病人为主键合并起来我们就能够得到最终的数据集。

我们将数据集中的"颅内感染"抽出来作为训练目标。

## 训练集测试集分离

我们将数据混淆并以一定比例分离成训练集和测试集

## 模型选择

随机森林二分类（简单粗暴）

## 调参

放了十几个参数让程序执行网格搜索得到最优参数（和没设基本没区别）

## 结果

在测试集得到了 90%的正确率
