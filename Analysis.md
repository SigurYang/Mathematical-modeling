# 一. 分析影响颅内感染的主要因素有哪些？

## 数据集观察

数据集主要可以作以下划分

| 说明：       | 病人唯一标识 | 性别/年龄   | 主要诊断+其他诊断\*n       | (手术方式/麻醉方式)n + 手术持续时间      | 样本编号(采样次数唯一标识) | 量化项目            |
| :----------- | :----------- | :---------- | :------------------------- | :--------------------------------------- | -------------------------- | ------------------- |
| 原数据标识： | mr_bah       | mr_xb/mr_nn | mr_cyzyzdmc+mr_cyqtzdmc{n} | mr_ssmzfs{n}/mr_sscxsj{n} + mr_ssmzfs{k} | item_code                  | result quantitative |

其中“颅内感染”主要包含在诊断中。数据的对应关系是 1 个病人对应 n 个样本编号（n 不固定）。

对于以上的数据集划分，我们很自然地想到了颅内感染的可能影响因素：

1. 其他病症对“颅内感染”的发生有影响
2. 手术方式对“颅内感染”的发生有影响
3. 手术时间对“颅内感染”的发生有影响

## 数据集预处理

取出数据集中的 [病人唯一标识,性别/年龄,主要诊断+其他诊断\*n,(手术方式/麻醉方式)n + 手术持续时间] 并去除重复列，这样我们就能得到由病人唯一标识作为索引的数据集。

## 分析其他病症对“颅内感染”的影响

(内容详见./illness_analysis.ipynb)

既然每个病人所包含的病症数量不统一，且为了方便后续的操作，我们先把数据中的每项病症转化成 one_hot_encoding。

##### 什么是 one hot?

例：

    给定一个标签列表[A,D,C,B],我们需要将其转化成0-1编码，即：
    ["A","B","C","D"]
    [1,0,0,0]
    [0,0,0,1]
    [0,0,1,0]
    [0,1,0,0]

这样我们就获得了由 onehot encode 的数据集，但是有一些病症的样本数量过少，我们选择去除掉样本数量过少的标签。(详见./outputs/onehot_illness.csv)

#### 相关性系数

为了分析不同病症之间的相关性，我们直接对 onehot 数据集计算皮尔逊相关性系数，这样我们就能得到每个病症对于其他病症的相关性。(结果详见./outputs/corr.csv),我们只需要取出其中“颅内感染”这一列的值就可以得知“颅内感染”与其他病症的相关性。

但是这样做只能解释相关性，而非原因，即：

- 颅内感染与其他疾病并发
- 颅内感染导致了其他疾病
- 其他疾病导致了颅内感染

#### 条件概率

已知条件概率计算方式如下：
$A="颅内感染"$,$B="任一病症"$
$$P(A|B) = P(AB)/P(B)$$

即我们可以使用条件概率来判断两个因素：[颅内感染与其他疾病并发,其他疾病导致了颅内感染]

我们即先计算所有病症的共同发生频率，(详见./outputs/occur.csv)，即 $P(AB)$，再除以 $P(B)$ ，即共发矩阵的对角线，即可得出条件概率。

#### 第一层结论

我们给相关性系数和条件概率的输出分布设置了阈值，即高于这个阈值我们认为其存在相关性。将两个高相关性结果求交集即可得到我们的第一层结论：存在某些病症是“颅内感染”的原因。

但是至此我们也仅仅是判断了两层因素：[颅内感染与其他疾病并发,其他疾病导致了颅内感染]

#### 贝叶斯网络

为了得到"其他疾病导致了颅内感染"的结论，我们采用贝叶斯网络对结果进行归因，最后得出[是什么疾病导致了颅内感染]

#### 量化结果分析

(详见./time_series_analysis.ipynb)

但是上面得出的结论是否是真正的结论呢，我们查看一些高概率的结果的频数发现只有 3-5 次，这意味着我们的结论不具备普遍统计意义，为了说明我们的结论正确性，我们对量化结果进行分析。

##### 为什么要分析量化结果？

量化结果是病症的原因，即得了某些病或者做了某些手术后我能看到人体的某些指标发生了变化，若“颅内感染”患者与“非颅内感染”患者在某些量化指标上存在明显差异，则我们可以尝试查询一些我们上面分析得出的结论对于的量化结果是否与“非颅内感染”患者存在明显差异，若存在明显差异则说明我们的结论是成立的。

##### 量化数据预处理

我们取出数据中的 [病人唯一标识， 样本编号(采样次数唯一标识) , 量化项目 ] 并将不同的量化项目直接嵌入到同一行中，这样我们就能够获得以样本编号为唯一标识的时间序列数据集。(详见./outputs/time_factor.csv)

##### 量化数据分析

因为第一次的量化分析距离病人的诊断最近，因此最有可能与病症产生关联，因此我们分析每一个病人的第一次量化数据，最后发现"颅内感染”患者与“非颅内感染”患者在三项蛋白指标上有明显差异，我们将这个作为判断依据。

## 分析手术对“颅内感染”的影响

重复上述流程(详见./op_analysis.ipynb)

# 二. 构建颅内感染的风险模型

(详见 model_build.ipynb)

## 时间序列处理

因为量化数据的采样时间越靠前，其指标就越与病症相关，并且我们的预测模型也只能预测定长数据，因此我们决定将时间序列压缩到一个值。

为了让采用时间越前的数据提供的重要性越高，我们对时间序列采用了指数平均:

$$\frac{\exp(-\alpha x)}{\left(\frac{1}{\alpha}\right) \exp(-\alpha n)}$$

## 输入数据

直接将上述所有预处理步骤得到的 one_hot ecoding 以病人为主键合并起来我们就能够得到最终的数据集。

我们将数据集中的"颅内感染"抽出来作为训练目标。

## 训练集测试集分离

我们将数据混淆并以一定比例分离成训练集和测试集

## 模型选择

随机森林二分类（简单粗暴）

## 调参

放了十几个参数让程序执行网格搜索得到最优参数（和没设基本没区别）

## 结果

在测试集得到了 90%的正确率
